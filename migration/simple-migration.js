#!/usr/bin/env node

/**
 * Simple WordPress to Supabase Migration Script
 * Manually migrates key content from WordPress to Supabase
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '../.env.local' });

// Supabase configuration
const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_KEY;

if (!SUPABASE_SERVICE_KEY || !SUPABASE_URL) {
  console.error('‚ùå SUPABASE_URL and SUPABASE_SERVICE_KEY environment variables are required');
  console.error('Make sure .env.local file exists with correct Supabase configuration');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

class SimpleMigrator {
  async clearExistingData() {
    console.log('üßπ Clearing existing data...');
    
    try {
      // Delete in reverse order due to foreign key constraints
      const { error: postsError } = await supabase.from('posts').delete().gte('id', 0);
      if (postsError) console.log('Posts clear error:', postsError.message);
      
      const { error: tagsError } = await supabase.from('tags').delete().gte('id', 0);
      if (tagsError) console.log('Tags clear error:', tagsError.message);
      
      const { error: categoriesError } = await supabase.from('categories').delete().gte('id', 0);
      if (categoriesError) console.log('Categories clear error:', categoriesError.message);
      
      const { error: usersError } = await supabase.from('users').delete().gte('id', 0);
      if (usersError) console.log('Users clear error:', usersError.message);
      
      console.log('‚úÖ Existing data cleared');
    } catch (error) {
      console.error('‚ö†Ô∏è  Error clearing data (this might be expected):', error.message);
    }
  }

  async migrateUsers() {
    console.log('üë• Migrating users...');
    
    const users = [
      {
        wp_id: 1,
        username: 'admin',
        email: 'admin@zayotech.com',
        full_name: 'Admin User',
        display_name: 'Admin',
        user_login: 'admin',
        user_url: 'https://zayotech.com',
        role: 'admin',
        registered_at: '2023-07-20 22:58:21'
      },
      {
        wp_id: 2,
        username: 'author',
        email: 'author@zayotech.com',
        full_name: 'Content Author',
        display_name: 'Author',
        user_login: 'author',
        user_url: 'https://zayotech.com',
        role: 'author',
        registered_at: '2023-07-20 22:58:21'
      }
    ];

    const { data, error } = await supabase
      .from('users')
      .upsert(users, { onConflict: 'wp_id' });

    if (error) {
      console.error('‚ùå Error migrating users:', error);
      throw error;
    }

    console.log(`‚úÖ Migrated ${users.length} users`);
    return data;
  }

  async migrateCategories() {
    console.log('üìÅ Migrating categories...');
    
    const categories = [
      {
        wp_id: 1,
        name: 'Love Shayari',
        slug: 'love-shayari',
        description: 'Beautiful love shayari in Hindi'
      },
      {
        wp_id: 2,
        name: 'Sad Shayari',
        slug: 'sad-shayari',
        description: 'Heart touching sad shayari'
      },
      {
        wp_id: 3,
        name: 'Motivational Quotes',
        slug: 'motivational-quotes',
        description: 'Inspirational and motivational quotes'
      },
      {
        wp_id: 4,
        name: 'Hindi Shayari',
        slug: 'hindi-shayari',
        description: 'Collection of Hindi shayari'
      },
      {
        wp_id: 5,
        name: 'Friendship Shayari',
        slug: 'friendship-shayari',
        description: 'Shayari about friendship'
      }
    ];

    const { data, error } = await supabase
      .from('categories')
      .upsert(categories, { onConflict: 'wp_id' });

    if (error) {
      console.error('‚ùå Error migrating categories:', error);
      throw error;
    }

    console.log(`‚úÖ Migrated ${categories.length} categories`);
    return data;
  }

  async migrateTags() {
    console.log('üè∑Ô∏è Migrating tags...');
    
    const tags = [
      { wp_id: 1, name: 'Hindi', slug: 'hindi', description: 'Hindi content' },
      { wp_id: 2, name: 'Shayari', slug: 'shayari', description: 'Shayari posts' },
      { wp_id: 3, name: 'Love', slug: 'love', description: 'Love related content' },
      { wp_id: 4, name: 'Sad', slug: 'sad', description: 'Sad content' },
      { wp_id: 5, name: 'Motivational', slug: 'motivational', description: 'Motivational content' },
      { wp_id: 6, name: 'Quotes', slug: 'quotes', description: 'Quotes and sayings' },
      { wp_id: 7, name: 'Friendship', slug: 'friendship', description: 'Friendship content' },
      { wp_id: 8, name: 'Life', slug: 'life', description: 'Life related content' },
      { wp_id: 9, name: 'Inspirational', slug: 'inspirational', description: 'Inspirational content' },
      { wp_id: 10, name: 'Heart Touching', slug: 'heart-touching', description: 'Emotional content' }
    ];

    const { data, error } = await supabase
      .from('tags')
      .upsert(tags, { onConflict: 'wp_id' });

    if (error) {
      console.error('‚ùå Error migrating tags:', error);
      throw error;
    }

    console.log(`‚úÖ Migrated ${tags.length} tags`);
    return data;
  }

  async migratePosts() {
    console.log('üìù Migrating posts...');
    
    // Get user and category mappings
    const { data: users } = await supabase.from('users').select('id, wp_id');
    const { data: categories } = await supabase.from('categories').select('id, wp_id');
    
    const userMap = new Map(users.map(u => [u.wp_id, u.id]));
    const categoryMap = new Map(categories.map(c => [c.wp_id, c.id]));

    const posts = [
      {
        wp_id: 196,
        title: 'Inspirational Quotes',
        slug: 'inspirational-quotes',
        content: `<!-- wp:paragraph {"align":"center"} -->
<p class="has-text-align-center"><strong>Inspirational Quotes:</strong> Here are more than 100 of the best English quotes that can motivate you every day. If you want to be successful, you must always keep yourself inspired. You will get a lot out of these words, and they will change your life.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph {"align":"center"} -->
<p class="has-text-align-center">‡§Ø‡§π‡§æ‡§Ç ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•å ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡§∞‡•ç‡§µ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§† ‡§™‡•ç‡§∞‡•á‡§∞‡§£‡§æ‡§¶‡§æ‡§Ø‡§ï ‡§â‡§¶‡•ç‡§ß‡§∞‡§£ ‡§Æ‡§ø‡§≤‡•á‡§Ç‡§ó‡•á, ‡§ú‡•ã ‡§Ü‡§™‡§ï‡•ã ‡§π‡§∞ ‡§¶‡§ø‡§® ‡§™‡•ç‡§∞‡•á‡§∞‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§ ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§∏‡§´‡§≤‡§§‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡•ã ‡§π‡§Æ‡•á‡§∂‡§æ ‡§™‡•ç‡§∞‡•á‡§∞‡§ø‡§§ ‡§∞‡§π‡•á‡§Ç‡•§ ‡§Ü‡§™‡§ï‡•Ä ‡§ú‡§ø‡§Ç‡§¶‡§ó‡•Ä ‡§á‡§® ‡§ï‡•ã‡§ü‡•ç‡§∏ ‡§∏‡•á ‡§¨‡§¶‡§≤ ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§</p>
<!-- /wp:paragraph -->

<!-- wp:quote -->
<blockquote class="wp-block-quote">
<p>Calm is a superpower.</p>
</blockquote>
<!-- /wp:quote -->

<!-- wp:quote -->
<blockquote class="wp-block-quote">
<p>Everything you can imagine is real.</p>
</blockquote>
<!-- /wp:quote -->

<!-- wp:quote -->
<blockquote class="wp-block-quote">
<p>You are never too old to set another goal or to dream a new dream.</p>
</blockquote>
<!-- /wp:quote -->`,
        excerpt: 'Inspirational Quotes: Here are more than 100 of the best English quotes that can motivate you every day.',
        status: 'published',
        author_id: userMap.get(2),
        category_id: categoryMap.get(3),
        published_at: '2024-02-21 15:37:46',
        reading_time: 5
      },
      {
        wp_id: 228,
        title: 'Happy New Year Wishes in Hindi',
        slug: 'happy-new-year-wishes-in-hindi',
        content: `<!-- wp:paragraph {"align":"center"} -->
<p class="has-text-align-center">‡§®‡§µ ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•á ‡§á‡§∏ ‡§∂‡•Å‡§≠ ‡§Ö‡§µ‡§∏‡§∞ ‡§™‡§∞ ‡§π‡§Æ ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•á‡§ï‡§∞ ‡§Ü‡§Ø‡•á ‡§π‡•à‡§Ç ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§ì‡§Ç ‡§î‡§∞ ‡§∂‡§æ‡§Ø‡§∞‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§è‡§ï ‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§® ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•§</p>
<!-- /wp:paragraph -->

<!-- wp:quote -->
<blockquote class="wp-block-quote">
<p>‡§®‡§Ø‡§æ ‡§∏‡§æ‡§≤ ‡§Ü‡§™‡§ï‡•á ‡§ú‡•Ä‡§µ‡§® ‡§Æ‡•á‡§Ç ‡§ñ‡•Å‡§∂‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§¨‡§æ‡§∞‡§ø‡§∂ ‡§≤‡§æ‡§è,<br>
‡§π‡§∞ ‡§¶‡§ø‡§® ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§à ‡§â‡§Æ‡§Ç‡§ó ‡§î‡§∞ ‡§®‡§à ‡§Ü‡§∂‡§æ ‡§≤‡§æ‡§è‡•§<br>
‡§®‡§µ ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•Ä ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç!</p>
</blockquote>
<!-- /wp:quote -->

<!-- wp:quote -->
<blockquote class="wp-block-quote">
<p>‡§¨‡•Ä‡§§‡•á ‡§∏‡§æ‡§≤ ‡§ï‡•Ä ‡§Ø‡§æ‡§¶‡•á‡§Ç ‡§¶‡§ø‡§≤ ‡§Æ‡•á‡§Ç ‡§¨‡§∏‡•Ä ‡§∞‡§π‡•á‡§Ç,<br>
‡§®‡§è ‡§∏‡§æ‡§≤ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§≠‡•Ä ‡§Æ‡•Å‡§∞‡§æ‡§¶‡•á‡§Ç ‡§™‡•Ç‡§∞‡•Ä ‡§π‡•ã‡§Ç‡•§<br>
Happy New Year 2024!</p>
</blockquote>
<!-- /wp:quote -->`,
        excerpt: '‡§®‡§µ ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•á ‡§á‡§∏ ‡§∂‡•Å‡§≠ ‡§Ö‡§µ‡§∏‡§∞ ‡§™‡§∞ ‡§π‡§Æ ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•á‡§ï‡§∞ ‡§Ü‡§Ø‡•á ‡§π‡•à‡§Ç ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§ì‡§Ç ‡§î‡§∞ ‡§∂‡§æ‡§Ø‡§∞‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§è‡§ï ‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§® ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•§',
        status: 'published',
        author_id: userMap.get(2),
        category_id: categoryMap.get(1),
        published_at: '2023-08-09 17:01:08',
        reading_time: 3
      },
      {
        wp_id: 300,
        title: 'Love Shayari in Hindi',
        slug: 'love-shayari-in-hindi',
        content: `<!-- wp:paragraph {"align":"center"} -->
<p class="has-text-align-center">‡§™‡•ç‡§∞‡•á‡§Æ ‡§ï‡•Ä ‡§ó‡§π‡§∞‡§æ‡§à ‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§∏‡§¨‡§∏‡•á ‡§ñ‡•Ç‡§¨‡§∏‡•Ç‡§∞‡§§ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∂‡§æ‡§Ø‡§∞‡•Ä ‡§ï‡§æ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•§</p>
<!-- /wp:paragraph -->

<!-- wp:quote -->
<blockquote class="wp-block-quote">
<p>‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‡§Æ‡•ã‡§π‡§¨‡•ç‡§¨‡§§ ‡§Æ‡•á‡§Ç ‡§π‡§Æ‡§®‡•á ‡§ú‡•ã ‡§ñ‡•Å‡§∂‡•Ä ‡§™‡§æ‡§à ‡§π‡•à,<br>
‡§µ‡•ã ‡§ñ‡•Å‡§∂‡•Ä ‡§π‡§Æ‡•á‡§Ç ‡§ú‡§®‡•ç‡§®‡§§ ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§§‡•Ä‡•§<br>
‡§§‡•Å‡§Æ ‡§π‡•ã ‡§§‡•ã ‡§ú‡§ø‡§Ç‡§¶‡§ó‡•Ä ‡§π‡•à, ‡§§‡•Å‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§§‡•ã ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§®‡§π‡•Ä‡§Ç‡•§</p>
</blockquote>
<!-- /wp:quote -->

<!-- wp:quote -->
<blockquote class="wp-block-quote">
<p>‡§á‡§∂‡•ç‡§ï‡§º ‡§Æ‡•á‡§Ç ‡§π‡§Æ‡§®‡•á ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§§‡•Å‡§Æ‡•ç‡§π‡•á‡§Ç ‡§ö‡§æ‡§π‡§æ ‡§π‡•à,<br>
‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•á ‡§∏‡§ø‡§µ‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§î‡§∞ ‡§ï‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•á‡§ñ‡§æ ‡§π‡•à‡•§<br>
‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‡§Æ‡•ã‡§π‡§¨‡•ç‡§¨‡§§ ‡§π‡•Ä ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§ú‡§ø‡§Ç‡§¶‡§ó‡•Ä ‡§π‡•à‡•§</p>
</blockquote>
<!-- /wp:quote -->`,
        excerpt: '‡§™‡•ç‡§∞‡•á‡§Æ ‡§ï‡•Ä ‡§ó‡§π‡§∞‡§æ‡§à ‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§∏‡§¨‡§∏‡•á ‡§ñ‡•Ç‡§¨‡§∏‡•Ç‡§∞‡§§ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∂‡§æ‡§Ø‡§∞‡•Ä ‡§ï‡§æ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•§',
        status: 'published',
        author_id: userMap.get(2),
        category_id: categoryMap.get(1),
        published_at: '2023-08-10 10:30:00',
        reading_time: 4
      }
    ];

    const { data, error } = await supabase
      .from('posts')
      .upsert(posts, { onConflict: 'wp_id' });

    if (error) {
      console.error('‚ùå Error migrating posts:', error);
      throw error;
    }

    console.log(`‚úÖ Migrated ${posts.length} posts`);
    return data;
  }

  async run() {
    try {
      console.log('üöÄ Starting Simple WordPress to Supabase migration...\n');
      
      await this.clearExistingData();
      await this.migrateUsers();
      await this.migrateCategories();
      await this.migrateTags();
      await this.migratePosts();
      
      console.log('\nüéâ Migration completed successfully!');
      console.log('\nüìä Migration Summary:');
      console.log('   üë• Users migrated: 2');
      console.log('   üìÅ Categories migrated: 5');
      console.log('   üè∑Ô∏è  Tags migrated: 10');
      console.log('   üìù Posts migrated: 3');
      
    } catch (error) {
      console.error('\n‚ùå Migration failed:', error.message);
      process.exit(1);
    }
  }
}

// Run migration if called directly
if (require.main === module) {
  const migrator = new SimpleMigrator();
  migrator.run();
}

module.exports = SimpleMigrator;
